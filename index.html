<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Global Terrorism Database: history of attacks ðŸ’£</title>
    <style>
        body {
            background: #eee;
        }

        section {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #graphs {
            width: 1000px;
            height: 600px;
        }

        #areachart, #map {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        #map{
            margin-bottom:50px;
        }

        #input {
            height: 30px;
            padding: 5px 25px 5px 45px;
        }

        #input input {
            width: 100%;
            background: transparent;
        }

        nav {
            margin: 0 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            background: #fff;
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            overflow:hidden;
            border-radius:4px;
        }

        nav div {
            text-align: center;
            display: flex;
            position: relative;
            justify-content: space-between;
            align-items: center;
        }

        nav img {
            margin: 5px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            padding: 5px;
            border-radius: 25%;
        }

        nav div p {
            display: none;
            font-size: 10px;
            position: absolute;
            /*TODO: Transitioning still does not work*/
            transition: all 0.4s ease-in-out;
            padding: 10px;
            opacity: 0;
            left: 0;
            top: 0;
            bottom: 0;
            font-family: sans-serif;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            background: #fff;
            z-index: -1;
        }

        nav div:hover p {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            left: 98%;
        }

        #playbutton { align-self: flex-start; margin-top: 620px; transition: all 0.4s ease-in-out; background: #fff;}
        #playbutton #play { display:block; }
        #playbutton #stop { display:none; }
        #playbutton.active { box-shadow: 0 3px 6px rgba(0,0,0,0.23), 0 1px 2px rgba(0, 0, 0, 0.24); background: #90a4ae; }
        #playbutton.active #play { display:none; }
        #playbutton.active #stop { display:block; }

    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
</head>
<body>

<section>
    <nav id="playbutton">
        <img id="play" src="assets/play.svg" />
        <img id="stop" src="assets/stop.svg" />
    </nav>
    <div id="graphs">
        <div id="areachart"></div>
        <div id="input"><input type="range" id="timeslider" name="year" min="1970" max="2015" value="1970"></div>
        <div id="map"></div>
    </div>
    <nav id="map_methods">
      <div><img src="assets/0.svg" id = 'attacktype0' data-attacktype="0" onClick='opacityFunction(0), backgroundActive(0)' style='background-color: white'/></div>
      <div><img src="assets/1.svg" id = 'attacktype1' data-attacktype="1" onClick='opacityFunction(1), backgroundActive(1)' style='background-color: white'/></div>
      <div><img src="assets/2.svg" id = 'attacktype2' data-attacktype="2" onClick='opacityFunction(2), backgroundActive(2)' style='background-color: white'/></div>
      <div><img src="assets/3.svg" id = 'attacktype3' data-attacktype="3" onClick='opacityFunction(3), backgroundActive(3)' style='background-color: white'/></div>
      <div><img src="assets/4.svg" id = 'attacktype4' data-attacktype="4" onClick='opacityFunction(4), backgroundActive(4)' style='background-color: white'/></div>
      <div><img src="assets/5.svg" id = 'attacktype5' data-attacktype="5" onClick='opacityFunction(5), backgroundActive(5)' style='background-color: white'/></div>
      <div><img src="assets/6.svg" id = 'attacktype6' data-attacktype="6" onClick='opacityFunction(6), backgroundActive(6)' style='background-color: white'/></div>
      <div><img src="assets/7.svg" id = 'attacktype7' data-attacktype="7" onClick='opacityFunction(7), backgroundActive(7)' style='background-color: white'/></div>
      <div><img src="assets/8.svg" id = 'attacktype8' data-attacktype="8" onClick='opacityFunction(8), backgroundActive(8)' style='background-color: white'/></div>
      <div><img src="assets/9.svg" id = 'attacktype9' data-attacktype="9" onClick='opacityFunction(9), backgroundActive(9)' style='background-color: white'/></div>
    </nav>
</section>
<script>

    // Variable declaration
    var dataset = "dataset/globalterrorismdb.csv";
    var attacksDataset = "dataset/attacktypes.csv";
    var attackTypes = ["Suicide Bombing", "Assassination", "Armed Assault", "Bombing/Explosion", "Hijacking", "Barricade Incident", "Kidnapping", "Facility/Infrastructure Attack", "Unarmed Assault", "Unknown"];
    var yearInput = document.querySelector("#input input");
    var countries = document.querySelectorAll(".datamaps-subunits path");
    var playbutton = document.querySelector("#playbutton");
    var imageButtons = document.querySelectorAll("#map_methods div img");
    var year = 1970;
    var running = false;
    var animationTimer;


    // Add names to image labels
    imageButtons.forEach(function (image) {
        // Add paragraph with attack type
        var node = document.createElement("P");
        var textNode = document.createTextNode(attackTypes[image.dataset.attacktype]);
        node.appendChild(textNode);
        image.parentNode.appendChild(node);
    });


    // Get input values
    yearInput.addEventListener("input", function (event) {
        year = this.value;
        updateView();
    });

    // Timing function
    playbutton.addEventListener("click", function (event) {

        running = !running;
        if(running){
            this.classList.add("active");
            animationTimer = setInterval(function(){
                year++;
                yearInput.value = year;
                updateView();
            }, 1000);
        }else{
            this.classList.remove("active");
            clearInterval(animationTimer)
        }

    });

    // The actual handler for applying changes. Use the global year variable.
    function updateView(){
        console.log(year);
    }

    // Opacity map function
    function opacityFunction(i) {
        if (d3.select("#b-" + i).style("fill-opacity") == 0.5) {
            d3.select("#b-" + i).transition()
                .duration(400)
                .style("fill-opacity", 1.0)
        } else {
            d3.select("#b-" + i).transition()
                .duration(400)
                .style("fill-opacity", 0.5);
        }
    };


    // Change the icon backgroundcolor to match the color of the areachart color if active
    function backgroundActive(i){
        var id = document.getElementById('attacktype' + i);
        if (id.style.backgroundColor !== "white") {
            id.style.backgroundColor = "white";
            id.style.transition = "all 1s";
        } else {
            id.style.backgroundColor = color(attackTypes[i]);
            id.style.transition = "all 1s";
        }
    };


    // Area chart variables
    var margin = {
        top: 20,
        right: 20,
        bottom: 30,
        left: 50
    };
    var width = 1000 - margin.left - margin.right;
    var height = 600 - margin.top - margin.bottom;
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    var parseDate = d3.timeParse('%Y');
    var x = d3.scaleTime()
        .range([0, width]);
    var y = d3.scaleLinear()
        .range([height, 0]);
    var xAxis = d3.axisBottom()
        .scale(x);
    var yAxis = d3.axisLeft()
        .scale(y);
    var area = d3.area()
        .x(function(d) {
            return x(d.data.Year);
        })
        .y0(function(d) {
            return y(d[0]);
        })
        .y1(function(d) {
            return y(d[1]);
        });
    var stack = d3.stack();
    var svg = d3.select("#areachart").append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    // Generate stacked area chart
    d3.csv(attacksDataset, function(error, data) {
        if (error) throw error;
        color.domain(d3.keys(data[0]).filter(function(key) {
            return key !== 'Year'
        }));
        var keys = data.columns.filter(function(key) {
            return key !== 'Year'
        });
        data.forEach(function(d) {
            d.Year = parseDate(d.Year);
        });
        tsvData = (function() {
            return data;
        })();

        var maxVal = d3.max(data, function(d) {
            var vals = d3.keys(d).map(function(key){
                if (key !== 'Year') {
                    return d[key];
                } else {
                    return 0;
                }
            });
            return d3.sum(vals);
        });

        x.domain(d3.extent(data, function(d) {
            return d.Year
        }));
        y.domain([0, maxVal]);

        stack.keys(keys);
        stack.order(d3.stackOrderNone);
        stack.offset(d3.stackOffsetNone);

        var stackedArea = svg.selectAll(".area")
            .data(stack(data))
            .enter()
            .append("g")
            .attr("class", "stackedArea")
            .attr("data-attacktype", function(d){
                return attackTypes.indexOf(d.key);
            })
            .attr('fill-opacity', 0.5)
            .attr("id", function(d, i) { return "b-" + i; });

        stackedArea.append("path")
            .attr("class", "area")
            .attr("d", area)
            .style("fill", function(d) {
                return color(d.key);
            });

        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .call(yAxis);
    });

    // Map variables
    var worldmap = d3.select("#map")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("class", "map");
    var projection = d3.geoMercator()
        .scale(130)
        .translate([width/2, height/1.5]);
    var path = d3.geoPath().projection(projection);


    // Generate map
    queue()
        .defer(d3.json, "dataset/world_countries.json")
        .await(function(error, data){
            if (error) throw error;

            worldmap.append("g")
                .attr("class", "countries")
                .selectAll("path")
                .data(data.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", function(d) {
                    return color(0);
                })
                .style("stroke", "white")
                .style("opacity", 0.5)
                .attr("class", "country")
                .on("click", clicked);

            worldmap.append("path")
                .datum(topojson.mesh(data.features, function(a, b) {
                    return a.id !== b.id;
                }))
                .attr("class", "names")
                .attr("d", path);
        });


    // Zoom map function
    var centered;
    function clicked(d) {
        var x, y, k;
        if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid [0];
            y = centroid[1];
            k = 4;
            centered = d;
        } else {
            x = width / 2;
            y = height / 2;
            k = 1;
            centered = null;
        }

        worldmap.selectAll("path")
            .classed("active", centered && function(d){
                    return d === centered;
                });

        worldmap.transition()
            .duration(500)
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")");
    }

</script>
</body>
</html>
